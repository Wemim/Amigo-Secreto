<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéÅ Amigo Secreto</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;}

body{
  margin:0;
  min-height:100vh;
  background:url("https://images.unsplash.com/photo-1544025162-d76694265947") center/cover no-repeat;
  font-family: Arial, sans-serif;
}

.overlay{
  background:rgba(0,0,0,.6);
  min-height:100vh;
  padding:20px;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}

.card{
  background:#fff;
  width:100%;
  max-width:420px;
  padding:20px;
  border-radius:16px;
}

h1{
  text-align:center;
  color:#bfa046;
  margin:0 0 12px;
}

/* LISTA */
ul{
  list-style:none;
  padding:0;
  margin:0;
  max-height:55vh;
  overflow-y:auto;
}

li{
  padding:12px;
  margin-top:8px;
  background:#f4f4f4;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
}

li.viewed{
  background:#efe2a0;
}

/* ADM PANEL */
#admPanel{
  display:none;
  margin-top:15px;
  border-top:1px solid #ddd;
  padding-top:12px;
}

input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:15px;
}

button{
  background:#d4af37;
  border:none;
  font-weight:bold;
  cursor:pointer;
}

button:hover{opacity:.9}

/* BOT√ÉO ADM FLUTUANTE */
#admBtn{
  position:fixed;
  bottom:18px;
  right:18px;
  width:48px;
  height:48px;
  border-radius:50%;
  background:#d4af37;
  border:none;
  font-size:18px;
  cursor:pointer;
}
</style>
</head>

<body>
<div class="overlay">
  <div class="card">
    <h1>üéÑ Amigo Secreto</h1>

    <!-- LISTA -->
    <ul id="list"></ul>

    <!-- PAINEL ADM -->
    <div id="admPanel">
      <input id="nameInput" placeholder="Nome do participante">
      <button onclick="addName()">‚ûï Adicionar</button>
      <button onclick="drawNames()">üé≤ Sortear</button>
      <button onclick="resetAll()">üî¥ Resetar</button>
    </div>
  </div>
</div>

<button id="admBtn" onclick="openAdm()">‚öôÔ∏è</button>

<script>
const ADMIN_PASSWORD="1234";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyAoCPefKjU2dzTTdYdfQyJIzg0FUKndzOM",
  authDomain:"amigo-secreto-84eb6.firebaseapp.com",
  projectId:"amigo-secreto-84eb6",
  storageBucket:"amigo-secreto-84eb6.appspot.com",
  messagingSenderId:"778511384024",
  appId:"1:778511384024:web:3d8b1c332e6108db8206ad"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const list=document.getElementById("list");
const nameInput=document.getElementById("nameInput");
const admPanel=document.getElementById("admPanel");

let locked=false;

/* Status */
db.collection("config").doc("status").onSnapshot(doc=>{
  locked=doc.exists && doc.data().locked===true;
});

/* Lista */
db.collection("participants").onSnapshot(snapshot=>{
  list.innerHTML="";
  snapshot.forEach(doc=>{
    const li=document.createElement("li");
    li.textContent=doc.id;
    if(doc.data().viewed) li.classList.add("viewed");
    li.onclick=()=>openParticipant(doc.id,doc.data());
    list.appendChild(li);
  });
});

/* ADM */
function openAdm(){
  const pass=prompt("Senha ADM:");
  if(pass===ADMIN_PASSWORD){
    admPanel.style.display="block";
  }else{
    alert("Senha incorreta");
  }
}

/* Add */
async function addName(){
  if(locked){alert("Sorteio j√° realizado");return;}
  const name=nameInput.value.trim();
  if(!name)return;

  const ref=db.collection("participants").doc(name);
  if((await ref.get()).exists){
    alert("Nome j√° existe");return;
  }

  await ref.set({drawn:"",password:"",viewed:false});
  nameInput.value="";
}

/* Draw */
async function drawNames(){
  if(locked){alert("J√° sorteado");return;}

  const snap=await db.collection("participants").get();
  const names=snap.docs.map(d=>d.id);
  if(names.length<2){alert("M√≠nimo 2");return;}

  let shuffled,ok=false;
  while(!ok){
    shuffled=[...names].sort(()=>Math.random()-0.5);
    ok=true;
    for(let i=0;i<names.length;i++){
      if(names[i]===shuffled[i]) ok=false;
    }
  }

  for(let i=0;i<names.length;i++){
    await db.collection("participants").doc(names[i]).update({
      drawn:shuffled[i]
    });
  }

  await db.collection("config").doc("status").set({locked:true});
  alert("üéâ Sorteio realizado!");
}

/* Open */
function openParticipant(name,data){
  if(!data.drawn){alert("Ainda n√£o sorteado");return;}

  const pass=prompt(data.password?"Digite sua senha":"Crie uma senha:");
  if(!pass)return;

  if(!data.password){
    db.collection("participants").doc(name).update({
      password:pass,
      viewed:true
    });
    alert("üéÅ Seu amigo secreto √©: "+data.drawn);
  }else if(pass===data.password){
    db.collection("participants").doc(name).update({viewed:true});
    alert("üéÅ Seu amigo secreto √©: "+data.drawn);
  }else{
    alert("Senha incorreta");
  }
}

/* Reset */
async function resetAll(){
  if(!confirm("Apagar tudo?"))return;

  const snap=await db.collection("participants").get();
  for(const d of snap.docs){await d.ref.delete();}
  await db.collection("config").doc("status").set({locked:false});
  alert("Reset feito");
}
</script>
</body>
</html>
