<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ğŸ Amigo Secreto</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  background:url("https://images.unsplash.com/photo-1544025162-d76694265947") center/cover;
  font-family: Arial, sans-serif;
}
.overlay{
  background:rgba(0,0,0,.6);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card{
  background:#fff;
  width:100%;
  max-width:420px;
  padding:20px;
  border-radius:15px;
}
h1{
  text-align:center;
  color:#bfa046;
}
ul{
  list-style:none;
  padding:0;
}
li{
  padding:10px;
  margin-top:6px;
  background:#f4f4f4;
  border-radius:8px;
  cursor:pointer;
}
li.viewed{
  background:#efe2a0;
}
input,button{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  background:#d4af37;
  border:none;
  font-weight:bold;
  cursor:pointer;
}
button:hover{opacity:.9}

#admBtn{
  position:fixed;
  bottom:15px;
  right:15px;
  width:auto;
  padding:12px;
  border-radius:50%;
}

#admPanel{
  display:none;
  margin-top:15px;
  border-top:1px solid #ddd;
  padding-top:10px;
}
</style>
</head>

<body>
<div class="overlay">
  <div class="card">
    <h1>ğŸ„ Amigo Secreto</h1>

    <!-- LISTA VISÃVEL PRA TODOS -->
    <ul id="list"></ul>

    <!-- PAINEL ADM -->
    <div id="admPanel">
      <input id="nameInput" placeholder="Nome do participante">
      <button onclick="addName()">â• Adicionar</button>
      <button onclick="drawNames()">ğŸ² Sortear</button>
      <button onclick="resetAll()">ğŸ”´ Resetar</button>
    </div>
  </div>
</div>

<button id="admBtn" onclick="openAdm()">âš™ï¸</button>

<script>
/* ğŸ” SENHA DO ADMIN */
const ADMIN_PASSWORD = "1234";

/* ğŸ”¥ FIREBASE CONFIG (JÃ INSERIDO) */
const firebaseConfig = {
  apiKey: "AIzaSyAoCPefKjU2dzTTdYdfQyJIzg0FUKndzOM",
  authDomain: "amigo-secreto-84eb6.firebaseapp.com",
  projectId: "amigo-secreto-84eb6",
  storageBucket: "amigo-secreto-84eb6.appspot.com",
  messagingSenderId: "778511384024",
  appId: "1:778511384024:web:3d8b1c332e6108db8206ad"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const list = document.getElementById("list");
const nameInput = document.getElementById("nameInput");
const admPanel = document.getElementById("admPanel");

let locked = false;

/* ğŸ”’ STATUS GLOBAL */
db.collection("config").doc("status").onSnapshot(doc=>{
  locked = doc.exists && doc.data().locked === true;
});

/* ğŸ”„ LISTA EM TEMPO REAL */
db.collection("participants").onSnapshot(snapshot=>{
  list.innerHTML="";
  snapshot.forEach(doc=>{
    const li=document.createElement("li");
    li.textContent=doc.id;
    if(doc.data().viewed) li.classList.add("viewed");
    li.onclick=()=>openParticipant(doc.id,doc.data());
    list.appendChild(li);
  });
});

/* ğŸ” ABRIR PAINEL ADM */
function openAdm(){
  const pass=prompt("Senha ADM:");
  if(pass===ADMIN_PASSWORD){
    admPanel.style.display="block";
    alert("Painel ADM liberado");
  }else{
    alert("Senha incorreta");
  }
}

/* â• ADICIONAR NOME */
async function addName(){
  if(locked){alert("Sorteio jÃ¡ realizado");return;}
  const name=nameInput.value.trim();
  if(!name)return;

  const ref=db.collection("participants").doc(name);
  if((await ref.get()).exists){
    alert("Esse nome jÃ¡ existe");
    return;
  }

  await ref.set({
    drawn:"",
    password:"",
    viewed:false
  });

  nameInput.value="";
}

/* ğŸ² SORTEAR (SEM PEGAR A SI MESMO) */
async function drawNames(){
  if(locked){alert("Sorteio jÃ¡ feito");return;}

  const snap=await db.collection("participants").get();
  const names=snap.docs.map(d=>d.id);
  if(names.length<2){
    alert("MÃ­nimo 2 participantes");
    return;
  }

  let shuffled,ok=false;
  while(!ok){
    shuffled=[...names].sort(()=>Math.random()-0.5);
    ok=true;
    for(let i=0;i<names.length;i++){
      if(names[i]===shuffled[i]) ok=false;
    }
  }

  for(let i=0;i<names.length;i++){
    await db.collection("participants").doc(names[i]).update({
      drawn:shuffled[i]
    });
  }

  await db.collection("config").doc("status").set({locked:true});
  alert("ğŸ‰ Sorteio realizado com sucesso!");
}

/* ğŸ‘€ VER AMIGO SECRETO */
function openParticipant(name,data){
  if(!data.drawn){
    alert("Sorteio ainda nÃ£o realizado");
    return;
  }

  const pass=prompt(
    data.password ? "Digite sua senha:" : "Crie uma senha:"
  );
  if(!pass)return;

  if(!data.password){
    db.collection("participants").doc(name).update({
      password:pass,
      viewed:true
    });
    alert("ğŸ Seu amigo secreto Ã©: "+data.drawn);
  }else if(pass===data.password){
    db.collection("participants").doc(name).update({viewed:true});
    alert("ğŸ Seu amigo secreto Ã©: "+data.drawn);
  }else{
    alert("Senha incorreta");
  }
}

/* ğŸ”´ RESET ADM */
async function resetAll(){
  if(!confirm("Isso apagarÃ¡ tudo. Continuar?"))return;

  const snap=await db.collection("participants").get();
  for(const d of snap.docs){
    await d.ref.delete();
  }

  await db.collection("config").doc("status").set({locked:false});
  alert("Sistema resetado");
}
</script>
</body>
</html>
